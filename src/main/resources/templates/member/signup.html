<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>SB Admin 2 - SignUp</title>

    <!-- Custom fonts for this template-->
    <link href="/css/all.css" rel="stylesheet" type="text/css">
    <link
            href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i"
            rel="stylesheet">

    <!-- Custom styles for this template-->
    <link href="/css/sb-admin-2.css" rel="stylesheet">

</head>

<body class="bg-gradient-primary">

<div class="container">

    <div class="card o-hidden border-0 shadow-lg my-5">
        <div class="card-body p-0">
            <!-- Nested Row within Card Body -->
            <div class="row">
                <div class="col-lg-5 d-none d-lg-block bg-register-image"
                     style="align-items:center !important; display: flex !important; justify-content:center !important;">
                    <img src="/img/register.png" alt="이미지 자리" width="191" height="187">
                </div>
                <div class="col-lg-7">
                    <div class="p-5">
                        <div class="text-center">
                            <h1 class="h4 text-gray-900 mb-4">Create an Account!</h1>
                        </div>
                        <form action="/member/signup2" method="POST" id="signUpForm" class="user">
                            <div class="form-group row">
                                <!-- 6칸: 입력 필드 -->
                                <div class="col-sm-6">
                                    <input type="text" class="form-control form-control-user" id="inputId"
                                           name="userId" placeholder="ID">
                                </div>
                                <!-- 4칸: 중복 체크 결과 -->
                                <div class="col-sm-4">
                                    <span id="idCheckResult" style="font-size: 0.85rem; display: block;"></span>
                                </div>
                                <!-- 2칸: 버튼 -->
                                <div class="col-sm-2">
                                    <button type="button" class="btn btn-primary btn-user btn-block" id="checkIdBtn">
                                        Check
                                    </button>
                                </div>
                            </div>
                            <div class="form-group row">
                                <div class="col-sm-6 mb-3 mb-sm-0">
                                    <input type="password" class="form-control form-control-user"
                                           id="inputPassword" name="userPw" placeholder="Password">
                                </div>
                                <div class="col-sm-6">
                                    <input type="password" class="form-control form-control-user"
                                           id="repeatPassword" placeholder="Repeat Password">
                                </div>
                            </div>
                            <div class="form-group">
                                <input type="text" class="form-control form-control-user" id="inputName"
                                       name="userName"
                                       placeholder="Name">
                            </div>
                            <div class="form-group">
                                <input type="email" class="form-control form-control-user" id="inputEmail"
                                       name="userEmail"
                                       placeholder="Email Address">
                            </div>
                            <button type="button" id="submitBtn" class="btn btn-primary btn-user btn-block">
                                Register Account
                            </button>
                        </form>
                        <hr>
                        <div class="text-center">
                            <a class="small" href="/">Already have an account? Login!</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- Bootstrap core JavaScript-->
<script src="/js/jquery.min.js"></script>
<script src="/js/bootstrap.bundle.min.js"></script>

<!-- Core plugin JavaScript-->
<script src="/js/jquery.easing.min.js"></script>

<!-- Custom scripts for all pages-->
<script src="/js/sb-admin-2.min.js"></script>

<!-- axios 비동기 통신용 -->
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<th:block layout:fragment="script">
    <!--  자바 스크립트 추가 코드  -->
    <script>
        // 전역변수 설정
        let idCheckPass = false; // 아이디 중복 체크 안함.

        // ID 중복 체크 버튼 클릭 이벤트
        document.getElementById("checkIdBtn").addEventListener("click", function () {
            const id = document.getElementById("inputId").value.trim();
            if (!id) {
                alert("아이디를 입력해주세요.");
                return;  // 함수 호출시 더이상 진행하고 싶지 않을 때: return하면 종료
            }
            // id가 5글자 이상인지 체크
            if (id.length < 4) {
                alert("아이디는 최소 4글자 이상이어야 합니다. 다시 입력해주세요.");
                return;
            }
            // id를 서버로 보내면서 중복체크해달라고 요청하고
            //   화면이 넘어가지 않고, 원할 때(버튼 클릭) 순서랑 상관없이 서버와 통신하는 기술 필요:
            //   비동기통신(자바스크립트 기술: ajax, 에이작스)
            //   ==> XMLHttpRequest 객체, fetch(), axios 객체
            //       브라우저에 없으므로 layout.html에 cdn으로 연결
            //   ajax의 결과는 일반적으로 데이터만 받아온다. (int, boolean, string, float, list, map, ...)
            //   axios.get(요청 주소).then(응답받고 나서 처리할 내용);

            // 서버로 중복 체크 요청
            axios
                .get("/member/checkId?userId=" + id)
                .then(function (response) {
                    // axios.get(주소) : http 프로토콜을 만들어서 http 요청을 함.
                    // 응답이 오면 then이 실행됨.
                    // 익명함수안에 변수이름 하나를 넣어두면 거기에 응답객체를 넣어줌.
                    // alert(response.data);   // http의 body를 꺼내줌.  // MemberController의 checkId 메서드 return 값
                    // alert(response.status); // http의 응답코드를 꺼내줌.
                    const result = response.data;  // http body 추출
                    const idCheckResult = document.getElementById("idCheckResult");
                    if (result) {
                        // span 태그 사이에 넣어야함.
                        idCheckPass = true; // 아이디 중복 체크 완료
                        idCheckResult.style.color = "green";
                        idCheckResult.textContent = "🎉 사용 가능한 아이디.";
                    } else {
                        idCheckResult.style.color = "red";
                        idCheckResult.textContent = "⚠️ 이미 사용 중인 아이디.";
                    }
                })
                .catch(function (error) {
                    alert("아이디 중복 체크 중 오류가 발생했습니다. 잠시 후 다시 시도해주세요.");
                    console.log(error);
                });

            // 서버로부터 중복체크 결과를 받은 이후에 출력
            // (사용 가능한 아이디, 불가능한 아이디인지 출력)
        });

        // ID 입력 필드 변경 시 idCheckPass 초기화
        document.getElementById("inputId").addEventListener("input", function () {
            idCheckPass = false; // ID가 변경되면 중복 체크 상태 초기화
            const idCheckResult = document.getElementById("idCheckResult");
            idCheckResult.textContent = ""; // 결과 메시지도 초기화
        });

        // 폼 제출 버튼 클릭 이벤트
        document.getElementById("submitBtn").addEventListener("click", function () {
            const inputId = document.getElementById("inputId").value.trim();
            const inputPassword = document.getElementById("inputPassword").value.trim();
            const repeatPassword = document.getElementById("repeatPassword").value.trim();
            const inputName = document.getElementById("inputName").value.trim();
            const inputEmail = document.getElementById("inputEmail").value.trim();
            console.log(inputId + " " + inputPassword + " " + inputName + " " + inputEmail);

            // 유효성 검사
            // 이메일 정규식
            const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            // 이메일 형식 검증
            if (!emailPattern.test(inputEmail)) {
                alert("올바른 이메일 형식을 입력해주세요!");
                return;
            }
            // id 중복체크 여부
            if (idCheckPass != true) {
                alert("아이디 중복 체크를 완료해주세요.");
                return;
            }
            // 전체 입력은 다 한것인지 체크
            if (!inputId || !inputPassword || !inputName || !inputEmail) {
                alert("모든 입력값을 정확히 채워주세요.");
                return;
            }
            // pw == pw2 체크
            if (inputPassword !== repeatPassword) {
                alert("입력한 비밀번호가 일치하지 않습니다. 다시 확인해주세요.");
                return;
            }
            // pw가 4글자 이상인지 체크
            if (inputPassword.length < 4) {
                alert("비밀번호는 최소 4글자 이상이어야 합니다. 다시 입력해주세요.");
                return;
            }

            // 이 함수가 return으로 중단되지 않았으면 폼 전송해주세요
            // 자바스크립트로 유효성 검증 후 submit 하려면
            // form내의 button의 type을 type="button"으로 바꿔줌.
            // 폼 제출
            document.getElementById("signUpForm").submit();
            alert("회원가입이 완료되었습니다. 환영합니다!")
        });

    </script>
</th:block>
</body>

</html>